@page "/profile"
@inject Blazored.LocalStorage.ILocalStorageService ls;
@* @page "/profile/{Uid:int}" *@


@inject IJSRuntime JSRuntime
@using Infra.Helpers.ApiRequestHelper.UserApiRequest
@using Infra.Helpers.ApiRequestHelper.FriendApiRequest
@using Infra.Models

<PageTitle>HexTechX/ Profile</PageTitle>
<div class="container mx-0 my-4">
    <!-- Header -->
    <header class="text-black text-left py-2 pb-1 position-relative">
        <div class="d-flex position-relative">
            <button class="btn btn-outline-light me-3 active" @onclick="GoToNewFeed">
                <i class="bi bi-arrow-left"></i> Back
            </button>
            <h2 class="m-0">HexTechX</h2>
        </div>
    </header>
    <hr />
    <div class="row mt-2">
        <!-- Sidebar -->
        <aside class="col-md-3 text-center custom-sidebar">
            <img class="rounded-circle profile-image mb-3" src="image/RaidenEi.png" alt="Profile Image" />
            <h2 class="username">Profile</h2>
            <!-- Friend Requests Dropdown -->

            <div class="dropdown pe-2">
                <button @onclick="ToggleFriendList" class="friend-list-button">
                    Friend Lists (@friList.Count())
                </button>

                @if (isDropdownVisibleFriList)
                {
                    @if (friList != null && friList.Count() > 0)
                    {
                        <div class="friend-list-dropdown">
                            @foreach (var friend in friList)
                            {
                                <div class="friend-name d-flex justify-content-between align-items-center">
                                    <div class="me-auto">
                                        @friend.UserName
                                    </div>
                                    <div>
                                        <i class="fa-solid fa-trash text-danger" style="cursor: pointer;" @onclick="()=> RemoveFriend(loginUser,friend.ID)"></i>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                }
            </div>

            <!-- Friend Request List Dropdown -->
            <div class="dropdown mt-2 pe-2">
                <button @onclick="ToggleFriendRequest" class="friend-list-button">
                    Friend Requests (@friReqList.Count())
                </button>

                @if (isDropdownVisibleFriReq)
                {
                    @if (friReqList != null && friReqList.Count() > 0)
                    {
                        <div class="friend-list-dropdown">
                            @foreach (var friendReq in friReqList)
                            {
                                <div class="friend-name d-flex justify-content-between align-items-center">
                                    <div class="me-auto">
                                        @friendReq.FromUserName
                                    </div>
                                    <div>
                                        <i class="fa-solid fa-check text-success" style="cursor: pointer;" @onclick="()=> AcceptFriendRequest(friendReq.ID)"></i>

                                        <!-- Red Cross Icon -->
                                        <i class="fa-solid fa-xmark text-danger" style="cursor: pointer;" @onclick="()=> DeclineFriendRequest(friendReq.ID)"></i>
                                    </div>
                                </div>
                            }

                        </div>
                    }
                }
            </div>
        </aside>

        <!-- Main Content -->
        <main class="col-md-9">
            <!-- Profile Info -->
            <div class="mb-4 p-3 shadow-sm rounded profile-info">
                <p><strong>Name: @user.UserName</strong></p>
                <p><strong>Joined Since: @user.CreatedTime?.ToString("dd-MMM-yyyy hh:mm tt")</strong> </p>
                <p><strong>Total Posts: 1 </strong> | <strong>Total Likes: 5</strong> </p>

                <div class="button-container d-flex">
                    <button class="btn btn-primary w-50">Add Friend +</button>
                    <button class="edit-button w-20 ms-2">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                </div>
            </div>
            <!-- Posts -->
            <section class="posts">
                <h3 class="mb-3">Posts</h3>
                <PostCard></PostCard>
            </section>
        </main>
    </div>
</div>

@code {

    [Inject]
    IUserApiRequest userRequest { get; set; }
    [Inject]
    IFriendApiRequest FriListRequest { get; set; }
    [Inject]
    IFriendRequestApiRequest FriReqRequest { get; set; }

    [Parameter]
    public int Uid { get; set; } = 1;
    public int loginUser { get; set; }

    User user { get; set; } = new User();

    private List<User> friList { get; set; } = new List<User>();

    private List<FriendRequest> friReqList { get; set; } = new List<FriendRequest>();

    /// <summary>
    /// DropDown
    /// </summary>
    private bool isDropdownVisibleFriList = false; 
    private bool isDropdownVisibleFriReq = false;


    private void ToggleFriendList()
    {
        isDropdownVisibleFriList = !isDropdownVisibleFriList;
    }
    private void ToggleFriendRequest()
    {
        isDropdownVisibleFriReq = !isDropdownVisibleFriReq; 
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if(firstRender)
        {
            try
            {
                // Fetch user information by ID
                user = await userRequest.GetByID(Uid);
                // Set the username
                user.UserName = user?.UserName ?? "Unknown User";

                friReqList = await FriReqRequest.GetFriendRequest(Uid);                
                loginUser = await ls.GetItemAsync<int>("userId");
                await GetFriendList(Uid);
                await InvokeAsync(StateHasChanged);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error fetching user data: {ex.Message}");
                user.UserName = "Error loading user";
            }
        }

    }

    async Task GetFriendList(int localUid)
    {
        friList = await FriListRequest.GetFriends(localUid);
    }

    private async void GoToNewFeed()
    {
        await JSRuntime.InvokeVoidAsync("navigateTo", "/");
    }

    // Accept Friend Request
    private async Task AcceptFriendRequest(int friendRequestId)
    {
        await FriReqRequest.RespondFriendRequest(friendRequestId, true);

        await GetFriendList(Uid);

        friReqList = friReqList.Where(req => req.ID != friendRequestId).ToList();
    }

    // Decline Friend Request
    private async Task DeclineFriendRequest(int friendRequestId)
    {
        await FriReqRequest.RespondFriendRequest(friendRequestId, false);

        friReqList = friReqList.Where(req => req.ID != friendRequestId).ToList();
    }

    // Remove Friend 
    private async Task RemoveFriend(int userID,int friendListId)
    {
        await FriListRequest.RemoveFriend(userID, friendListId);
        await GetFriendList(Uid);

        // Remove from the list
        friList = friList.Where(flist => flist.ID != friendListId).ToList();

    }
}


